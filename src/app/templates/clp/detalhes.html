{% extends "layouts/base.html" %}

{% block title %}Detalhes do CLP{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/clp/detalhes.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/admin/management.css') }}">

{% endblock %}

{% block content %}
<div class="clp-detalhes">
    <div class="clp-tab-container">
        <div class="clp-tab-navigation" role="tablist" aria-label="Seções de detalhes do CLP">
            <button id="tab-operacao-button" class="clp-tab active" type="button" role="tab"
                    data-tab-target="operacao" aria-controls="tab-operacao" aria-selected="true">
                Operação
            </button>
            <button id="tab-configuracao-button" class="clp-tab" type="button" role="tab"
                    data-tab-target="configuracao" aria-controls="tab-configuracao" aria-selected="false">
                Configuração
            </button>
            <button id="tab-seguranca-button" class="clp-tab" type="button" role="tab"
                    data-tab-target="seguranca" aria-controls="tab-seguranca" aria-selected="false">
                Segurança &amp; Importação
            </button>
            {% if can_manage %}
            <button id="tab-gestao-button" class="clp-tab" type="button" role="tab"
                    data-tab-target="gestao" aria-controls="tab-gestao" aria-selected="false">
                Gestão
            </button>
            {% endif %}
        </div>

        <div class="clp-tab-panels">
            <section id="tab-operacao" class="clp-tab-panel active" data-tab-panel="operacao" role="tabpanel"
                     aria-labelledby="tab-operacao-button">
                <div class="status_clp">
                    <span id="statusText" class="{{ 'status_online' if clp.is_online else 'status_offline' }}">
                        Status: {{ 'Online' if clp.is_online else 'Offline' }}
                    </span>

                    <div id="connect-container" style="display: {{ 'none' if clp.is_online else 'inline-block' }};" class="form-acao">
                        <label for="portSelect">Porta:</label>
                        <select id="portSelect" class="input-form">
                            <option value="{{ clp.port }}">{{ clp.port }}</option>
                        </select>
                        <button id="btnConnect" data-ip="{{ clp.ip_address }}" data-vlan="{{ vlan_id if vlan_id is not none else clp.vlan_id }}"
                                class="btn-acao">Conectar</button>
                    </div>

                    <div id="disconnect-container" style="display: {{ 'inline-block' if clp.is_online else 'none' }};">
                        <button id="btnDisconnect" data-ip="{{ clp.ip_address }}" data-vlan="{{ vlan_id if vlan_id is not none else clp.vlan_id }}"
                                class="btn-acao">Desconectar</button>
                    </div>

                    <div id="mensagemCLP" role="status" class="clp-status-message"></div>
                </div>

                <div class="informacao_clp">
                    <h2>Informações do CLP</h2>
                    <ul>
                        <li class="info-item-editavel">
                            <strong>Nome:</strong>
                            <div id="viewMode">
                                <span id="clpName">{{ clp.name }}</span>
                            </div>
                            <div id="editMode" style="display: none;">
                                <input type="text" id="inputClpName" class="form-input" value="{{ clp.name }}">
                                <button id="saveNameBtn" class="btn">Salvar</button>
                                <button id="cancelNameBtn" class="btn btn-secondary">Cancelar</button>
                            </div>
                        </li>
                        <li><strong>Modelo:</strong> {{ clp.model or 'Desconhecido' }}</li>
                        <li><strong>Fabricante:</strong> {{ clp.manufacturer or 'Desconhecido' }}</li>
                        <li><strong>IP:</strong> <span id="clpIp">{{ clp.ip_address }}</span></li>
                        <li><strong>VLAN:</strong> {{ clp.vlan_id or 'Não definido' }}</li>
                        <li><strong>Máscara:</strong> {{ clp.subnet_mask or 'Não informado' }}</li>
                        <li><strong>Gateway:</strong> {{ clp.gateway or 'Não informado' }}</li>
                        <li><strong>Última leitura:</strong> {{ clp.last_seen.strftime('%d/%m/%Y %H:%M:%S') if clp.last_seen else 'Nunca registrada' }}</li>
                        <li><strong>Tags Associadas:</strong>
                            <ul class="tag-list" id="tag-list-container">
                                {% if tags %}
                                    {% for tag in tags %}
                                        <li class="tag-item">
                                            <span>{{ tag }}</span>
                                            <span class="remove-tag" data-tag="{{ tag }}" title="Remover Tag">&times;</span>
                                        </li>
                                    {% endfor %}
                                {% else %}
                                    <li id="no-tags-msg">Nenhuma tag associada.</li>
                                {% endif %}
                            </ul>
                        </li>
                        <li><strong>Portas Abertas:</strong>
                            <span id="listaportas">{{ clp.port }}</span>
                        </li>
                        <li><strong>Versão Firmware:</strong> {{ clp.firmware_version or 'N/A' }}</li>
                        <li><strong>Data de Registro:</strong> {{ clp.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</li>
                    </ul>
                </div>

                <div id="mensagem" role="status" class="clp-status-message"></div>

                <div class="informacao_clp">
                    <h2>Registradores monitorados</h2>
                    <p class="section-description">Acompanhe o estado geral e expanda um registrador para visualizar o histórico e os limites configurados.</p>
                    <div id="register-accordion" class="register-accordion" aria-live="polite"></div>
                </div>

                <div class="informacao_clp">
                    <h2>Logs de Atividade</h2>
                    <div id="logContainer" class="log-container"></div>
                </div>
            </section>

            <section id="tab-configuracao" class="clp-tab-panel" data-tab-panel="configuracao" role="tabpanel"
                     aria-labelledby="tab-configuracao-button" hidden>
                <div class="informacao_clp">
                    <h2>Adicionar Tag</h2>
                    <form id="formAddTag" onsubmit="return false;" class="form-acao">
                        <input type="text" id="inputTag" placeholder="Nova tag" required class="input-form">
                        <button id="btnAddTag" class="btn-acao">Adicionar</button>
                    </form>
                    <div id="tagMessage" class="tag-feedback"></div>
                </div>

                <div class="informacao_clp">
                    <h2>Sincronização automática</h2>
                    <p class="section-description">Utilize o protocolo configurado para tentar descobrir tags e atualizar o mapa de registradores automaticamente.</p>
                    <div class="protocol-action-buttons">
                        <button type="button" id="auto-discovery-sync" class="btn-acao" data-plc-id="{{ clp.id }}">Sincronizar tags e registradores</button>
                    </div>
                    <div id="auto-discovery-feedback" class="protocol-feedback" role="status" aria-live="polite"></div>
                </div>

                <div class="informacao_clp">
                    <h2>Leitor de Registrador Modbus</h2>
                    <form id="formReadRegister" onsubmit="return false;" class="form-acao">
                        <input type="number" id="inputAddress" placeholder="Endereço (ex: 0)" required class="input-form">
                        <button id="btnReadRegister" class="btn-acao">Ler Registrador</button>
                    </form>
                    <div id="readResult" class="resultado-acao"></div>
                </div>
            </section>

            <section id="tab-seguranca" class="clp-tab-panel" data-tab-panel="seguranca" role="tabpanel"
                     aria-labelledby="tab-seguranca-button" hidden>
                <div class="informacao_clp">
                    <h2>Segurança Industrial</h2>
                    <div class="security-overview" data-level="{{ security_report.level|lower|replace('í', 'i') }}">
                        <div class="security-score">
                            <span class="score-value">{{ security_report.score }}</span>
                            <span class="score-label">Score</span>
                            <span class="score-level">Risco {{ security_report.level }}</span>
                        </div>
                        <div class="security-highlights">
                            <h3>Principais destaques</h3>
                            {% if security_report.highlights %}
                                <ul>
                                    {% for item in security_report.highlights %}
                                        <li>
                                            <strong class="severity severity-{{ item.severity }}">{{ item.severity|capitalize }}</strong>
                                            <div>
                                                <span class="highlight-title">{{ item.title }}</span>
                                                <p>{{ item.description }}</p>
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p>Sem achados críticos registados.</p>
                            {% endif %}
                        </div>
                        <div class="security-recommendations">
                            <h3>Recomendações</h3>
                            <ol>
                                {% for recommendation in security_report.recommendations %}
                                <li>{{ recommendation }}</li>
                                {% endfor %}
                            </ol>
                        </div>
                    </div>
                </div>

                <div class="informacao_clp register-exchange">
                    <h2>Mapa industrial de tags</h2>
                    <p class="section-description">Arraste um ficheiro CSV ou XLSX exportado do engenheiro de configuração para registrar tags e endereços de forma padronizada.</p>
                    <div class="register-exchange__grid">
                        <div id="register-import-area" class="register-dropzone" data-plc-id="{{ clp.id }}">
                            <input type="file" id="register-import-input" accept=".csv,.xls,.xlsx" hidden>
                            <div class="register-dropzone__content">
                                <strong>Solte o arquivo aqui</strong>
                                <p>ou clique para selecionar.</p>
                                <span class="text-muted">Formatos suportados: CSV, XLS, XLSX.</span>
                            </div>
                        </div>
                        <div class="register-exchange__actions">
                            <div class="export-controls">
                                <label for="register-export-format">Formato de exportação</label>
                                <select id="register-export-format" class="input-form">
                                    <option value="xlsx">XLSX</option>
                                    <option value="csv">CSV</option>
                                </select>
                            </div>
                            <button type="button" id="register-export-current" class="btn-acao">Exportar CLP atual</button>
                            <p class="export-hint">A exportação consolida controladores, protocolos, tags e endereços seguindo práticas ISA-95.</p>
                        </div>
                    </div>
                    <div id="register-import-feedback" class="register-feedback" role="status" aria-live="polite"></div>
                </div>
            </section>

            {% if can_manage %}
            <section id="tab-gestao" class="clp-tab-panel" data-tab-panel="gestao" role="tabpanel"
                     aria-labelledby="tab-gestao-button" hidden>
                <div class="clp-admin-grid">
                    <div class="card clp-admin-card">
                        <div>
                            <h2>Actualizar CLP</h2>
                            <p class="card__description">Altere parâmetros de identificação, comunicação e contexto operativo directamente deste painel.</p>
                        </div>
                        {% if clp_form %}
                        <form method="POST" action="{{ url_for('admin.edit_clp', plc_id=clp.id) }}" novalidate>
                            {{ clp_form.hidden_tag() }}
                            <input type="hidden" name="next" value="{{ url_for('clp_bp.clp', ip=clp.ip_address, vlan=vlan_id) }}">
                            <div class="form-grid">
                                <label class="form-field{% if clp_form.name.errors %} has-error{% endif %}">
                                    <span>Nome</span>
                                    {{ clp_form.name(class_='input') }}
                                    {% if clp_form.name.errors %}<small class="input-error">{{ clp_form.name.errors[0] }}</small>{% endif %}
                                </label>
                                <label class="form-field{% if clp_form.ip_address.errors %} has-error{% endif %}">
                                    <span>IP</span>
                                    {{ clp_form.ip_address(class_='input') }}
                                    {% if clp_form.ip_address.errors %}<small class="input-error">{{ clp_form.ip_address.errors[0] }}</small>{% endif %}
                                </label>
                                <label class="form-field{% if clp_form.protocol.errors %} has-error{% endif %}">
                                    <span>Protocolo</span>
                                    {{ clp_form.protocol(class_='input') }}
                                    {% if clp_form.protocol.errors %}<small class="input-error">{{ clp_form.protocol.errors[0] }}</small>{% endif %}
                                </label>
                                <label class="form-field{% if clp_form.port.errors %} has-error{% endif %}">
                                    <span>Porta</span>
                                    {{ clp_form.port(class_='input') }}
                                    {% if clp_form.port.errors %}<small class="input-error">{{ clp_form.port.errors[0] }}</small>{% endif %}
                                </label>
                                <label class="form-field{% if clp_form.vlan_id.errors %} has-error{% endif %}">
                                    <span>VLAN</span>
                                    {{ clp_form.vlan_id(class_='input') }}
                                    {% if clp_form.vlan_id.errors %}<small class="input-error">{{ clp_form.vlan_id.errors[0] }}</small>{% endif %}
                                </label>
                                <label class="form-field{% if clp_form.subnet_mask.errors %} has-error{% endif %}">
                                    <span>Máscara</span>
                                    {{ clp_form.subnet_mask(class_='input') }}
                                    {% if clp_form.subnet_mask.errors %}<small class="input-error">{{ clp_form.subnet_mask.errors[0] }}</small>{% endif %}
                                </label>
                                <label class="form-field{% if clp_form.gateway.errors %} has-error{% endif %}">
                                    <span>Gateway</span>
                                    {{ clp_form.gateway(class_='input') }}
                                    {% if clp_form.gateway.errors %}<small class="input-error">{{ clp_form.gateway.errors[0] }}</small>{% endif %}
                                </label>
                                <label class="form-field{% if clp_form.unit_id.errors %} has-error{% endif %}">
                                    <span>Unit ID</span>
                                    {{ clp_form.unit_id(class_='input') }}
                                    {% if clp_form.unit_id.errors %}<small class="input-error">{{ clp_form.unit_id.errors[0] }}</small>{% endif %}
                                </label>
                                <label class="form-field{% if clp_form.manufacturer.errors %} has-error{% endif %}">
                                    <span>Fabricante</span>
                                    {{ clp_form.manufacturer(class_='input') }}
                                    {% if clp_form.manufacturer.errors %}<small class="input-error">{{ clp_form.manufacturer.errors[0] }}</small>{% endif %}
                                </label>
                                <label class="form-field{% if clp_form.model.errors %} has-error{% endif %}">
                                    <span>Modelo</span>
                                    {{ clp_form.model(class_='input') }}
                                    {% if clp_form.model.errors %}<small class="input-error">{{ clp_form.model.errors[0] }}</small>{% endif %}
                                </label>
                                <label class="form-field{% if clp_form.firmware_version.errors %} has-error{% endif %}">
                                    <span>Firmware</span>
                                    {{ clp_form.firmware_version(class_='input') }}
                                    {% if clp_form.firmware_version.errors %}<small class="input-error">{{ clp_form.firmware_version.errors[0] }}</small>{% endif %}
                                </label>
                                <label class="form-field{% if clp_form.tags.errors %} has-error{% endif %}">
                                    <span>Tags</span>
                                    {{ clp_form.tags(class_='input') }}
                                    {% if clp_form.tags.errors %}<small class="input-error">{{ clp_form.tags.errors[0] }}</small>{% endif %}
                                </label>
                                <label class="checkbox">{{ clp_form.is_active() }} Activo</label>
                            </div>
                            <label class="form-field{% if clp_form.description.errors %} has-error{% endif %}">
                                <span>Descrição</span>
                                {{ clp_form.description(class_='input', rows=3) }}
                                {% if clp_form.description.errors %}<small class="input-error">{{ clp_form.description.errors[0] }}</small>{% endif %}
                            </label>
                            <div class="actions">
                                {{ clp_form.submit(class_='btn primary') }}
                            </div>
                        </form>
                        {% else %}
                        <p class="text-muted">Sem permissões para editar este CLP.</p>
                        {% endif %}
                    </div>

                    <div class="card clp-admin-card">
                        <div>
                            <h2>Registradores associados</h2>
                            <p class="card__description">Edite endereço, escala e parâmetros operacionais de cada ponto monitorado.</p>
                        </div>
                        {% if register_forms %}
                        <div class="register-admin-list">
                            {% for register, form in register_forms %}
                            <details class="register-admin-item">
                                <summary>
                                    <span>{{ register.name }} — {{ register.register_type }} @ {{ register.address }}</span>
                                    <span class="status-indicator {{ 'status-indicator--online' if register.is_active else 'status-indicator--offline' }}">{{ 'Activo' if register.is_active else 'Inactivo' }}</span>
                                </summary>
                                <form method="POST" action="{{ url_for('admin.edit_register', register_id=register.id) }}" novalidate>
                                    {{ form.hidden_tag() }}
                                    <input type="hidden" name="next" value="{{ url_for('clp_bp.clp', ip=clp.ip_address, vlan=vlan_id) }}">
                                    <div class="form-grid">
                                        <label class="form-field{% if form.plc_id.errors %} has-error{% endif %}">
                                            <span>CLP</span>
                                            {{ form.plc_id(class_='input') }}
                                            {% if form.plc_id.errors %}<small class="input-error">{{ form.plc_id.errors[0] }}</small>{% endif %}
                                        </label>
                                        <label class="form-field{% if form.name.errors %} has-error{% endif %}">
                                            <span>Nome</span>
                                            {{ form.name(class_='input') }}
                                            {% if form.name.errors %}<small class="input-error">{{ form.name.errors[0] }}</small>{% endif %}
                                        </label>
                                        <label class="form-field{% if form.address.errors %} has-error{% endif %}">
                                            <span>Endereço</span>
                                            {{ form.address(class_='input') }}
                                            {% if form.address.errors %}<small class="input-error">{{ form.address.errors[0] }}</small>{% endif %}
                                        </label>
                                        <label class="form-field{% if form.register_type.errors %} has-error{% endif %}">
                                            <span>Tipo</span>
                                            {{ form.register_type(class_='input') }}
                                            {% if form.register_type.errors %}<small class="input-error">{{ form.register_type.errors[0] }}</small>{% endif %}
                                        </label>
                                        <label class="form-field{% if form.data_type.errors %} has-error{% endif %}">
                                            <span>Dados</span>
                                            {{ form.data_type(class_='input') }}
                                            {% if form.data_type.errors %}<small class="input-error">{{ form.data_type.errors[0] }}</small>{% endif %}
                                        </label>
                                        <label class="form-field{% if form.length.errors %} has-error{% endif %}">
                                            <span>Comprimento</span>
                                            {{ form.length(class_='input') }}
                                            {% if form.length.errors %}<small class="input-error">{{ form.length.errors[0] }}</small>{% endif %}
                                        </label>
                                        <label class="form-field{% if form.unit.errors %} has-error{% endif %}">
                                            <span>Unidade</span>
                                            {{ form.unit(class_='input') }}
                                            {% if form.unit.errors %}<small class="input-error">{{ form.unit.errors[0] }}</small>{% endif %}
                                        </label>
                                        <label class="form-field{% if form.tag.errors %} has-error{% endif %}">
                                            <span>Tag</span>
                                            {{ form.tag(class_='input') }}
                                            {% if form.tag.errors %}<small class="input-error">{{ form.tag.errors[0] }}</small>{% endif %}
                                        </label>
                                        <label class="form-field{% if form.scale_factor.errors %} has-error{% endif %}">
                                            <span>Factor de escala</span>
                                            {{ form.scale_factor(class_='input') }}
                                            {% if form.scale_factor.errors %}<small class="input-error">{{ form.scale_factor.errors[0] }}</small>{% endif %}
                                        </label>
                                        <label class="form-field{% if form.offset.errors %} has-error{% endif %}">
                                            <span>Offset</span>
                                            {{ form.offset(class_='input') }}
                                            {% if form.offset.errors %}<small class="input-error">{{ form.offset.errors[0] }}</small>{% endif %}
                                        </label>
                                        <label class="form-field{% if form.poll_rate.errors %} has-error{% endif %}">
                                            <span>Polling (ms)</span>
                                            {{ form.poll_rate(class_='input') }}
                                            {% if form.poll_rate.errors %}<small class="input-error">{{ form.poll_rate.errors[0] }}</small>{% endif %}
                                        </label>
                                        <label class="form-field">
                                            <span>Descrição</span>
                                            {{ form.description(class_='input') }}
                                        </label>
                                    </div>
                                    <div class="form-grid form-grid--compact">
                                        <label class="checkbox">{{ form.is_active() }} Activo</label>
                                        <label class="checkbox">{{ form.log_enabled() }} Histórico</label>
                                    </div>
                                    <div class="actions">
                                        {{ form.submit(class_='btn primary') }}
                                    </div>
                                </form>
                            </details>
                            {% endfor %}
                        </div>
                        {% else %}
                            <p class="text-muted">Não existem registradores associados a este CLP.</p>
                        {% endif %}
                    </div>
                </div>
            </section>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.min.js"></script>
<!-- <script src="{{ url_for('static', filename='scripts/graficos.js') }}"></script> -->
<script src="{{ url_for('static', filename='scripts/detalhes.js') }}"></script>
{% endblock %}
