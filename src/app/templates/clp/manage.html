{% extends "layouts/base.html" %}

{% block title %}Gestão de CLPs{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/admin/management.css') }}">
{% endblock %}

{% block content %}
{% set total_plcs = plcs|length %}
{% set active_plcs = plcs|selectattr('is_active')|list|length %}
{% set inactive_plcs = total_plcs - active_plcs %}
{% set ns = namespace(protocols=[]) %}
{% for plc in plcs %}
    {% if plc.protocol and plc.protocol not in ns.protocols %}
        {% set ns.protocols = ns.protocols + [plc.protocol] %}
    {% endif %}
{% endfor %}

<div class="management-container">
    <section class="page-header management-hero">
        <div>
            <p class="eyebrow">Inventário industrial</p>
            <h1>Controladores lógicos programáveis</h1>
            <p class="page-lead">Organize o parque de CLPs, mantenha metadados alinhados e garanta visibilidade operacional em tempo real.</p>
        </div>
        <div class="hero-actions">
            <a class="btn secondary" href="{{ url_for('admin.manage_registers') }}">Mapa de registradores</a>
            <a class="btn" href="{{ url_for('dashboard.dashboard_home') }}">Ir para dashboard</a>
        </div>
    </section>

    {% if polling_enabled is not none and not polling_enabled %}
    <div class="management-alert management-alert--warning" role="alert">
        <div>
            <strong>Polling desactivado.</strong>
            <span>Os CLPs permanecerão como offline até reactivar em <a href="{{ url_for('admin.manage_polling_control') }}">Controlo de Polling</a>.</span>
        </div>
    </div>
    {% endif %}

    <div class="management-tabs" data-management-tabs>
        <div class="management-tabs__controls" role="tablist">
            <button class="management-tab active" type="button" data-view-target="overview" role="tab" aria-selected="true">Resumo</button>
            <button class="management-tab" type="button" data-view-target="create" role="tab" aria-selected="false">Cadastrar CLP</button>
            <button class="management-tab" type="button" data-view-target="inventory" role="tab" aria-selected="false">Inventário</button>
        </div>

        <div class="management-tabs__panels">
            <section class="management-tab-panel active" data-view="overview" role="tabpanel">
                <div class="insight-grid">
                    <article class="insight-card">
                        <span class="insight-label">CLPs registados</span>
                        <span class="insight-value">{{ total_plcs }}</span>
                        <span class="insight-meta">{{ ns.protocols|length }} protocolos em operação</span>
                    </article>
                    <article class="insight-card">
                        <span class="insight-label">Activos</span>
                        <span class="insight-value">{{ active_plcs }}</span>
                        <span class="insight-meta">{{ (active_plcs / total_plcs * 100 if total_plcs else 0)|round(1) }}% do parque</span>
                    </article>
                    <article class="insight-card insight-card--critical">
                        <span class="insight-label">Inactivos</span>
                        <span class="insight-value">{{ inactive_plcs }}</span>
                        <span class="insight-meta">Priorize validação e manutenção preventiva</span>
                    </article>
                </div>

                <div class="mini-card-grid">
                    <article class="mini-card">
                        <h3>Protocolos mapeados</h3>
                        <p class="mini-card__description">{{ ns.protocols|map('upper')|join(', ') if ns.protocols else 'Sem protocolo definido' }}</p>
                    </article>
                    <article class="mini-card">
                        <h3>Últimas acções</h3>
                        <p class="mini-card__description">Utilize esta área para acompanhar cadastros recentes e garantir que metadados críticos estão preenchidos.</p>
                    </article>
                </div>
            </section>

            <section class="management-tab-panel" data-view="create" role="tabpanel" hidden>
                <div class="card">
                    <div>
                        <h2>Novo CLP</h2>
                        <p class="card__description">Defina identificação, parâmetros de rede e contexto operacional.</p>
                    </div>
                    <form method="POST" novalidate>
                        {{ form.hidden_tag() }}
                        <div class="form-grid">
                            <label class="form-field{% if form.name.errors %} has-error{% endif %}">
                                <span>Nome</span>
                                {{ form.name(class_='input') }}
                                {% if form.name.errors %}<small class="input-error">{{ form.name.errors[0] }}</small>{% endif %}
                            </label>
                            <label class="form-field{% if form.ip_address.errors %} has-error{% endif %}">
                                <span>IP</span>
                                {{ form.ip_address(class_='input') }}
                                {% if form.ip_address.errors %}<small class="input-error">{{ form.ip_address.errors[0] }}</small>{% endif %}
                            </label>
                            <label class="form-field{% if form.protocol.errors %} has-error{% endif %}">
                                <span>Protocolo</span>
                                {{ form.protocol(class_='input') }}
                                {% if form.protocol.errors %}<small class="input-error">{{ form.protocol.errors[0] }}</small>{% endif %}
                            </label>
                            <label class="form-field{% if form.port.errors %} has-error{% endif %}">
                                <span>Porta</span>
                                {{ form.port(class_='input') }}
                                {% if form.port.errors %}<small class="input-error">{{ form.port.errors[0] }}</small>{% endif %}
                            </label>
                            <label class="form-field{% if form.vlan_id.errors %} has-error{% endif %}">
                                <span>VLAN</span>
                                {{ form.vlan_id(class_='input', placeholder='ex: 10') }}
                                {% if form.vlan_id.errors %}<small class="input-error">{{ form.vlan_id.errors[0] }}</small>{% endif %}
                            </label>
                            <label class="form-field{% if form.subnet_mask.errors %} has-error{% endif %}">
                                <span>Máscara</span>
                                {{ form.subnet_mask(class_='input', placeholder='255.255.255.0') }}
                                {% if form.subnet_mask.errors %}<small class="input-error">{{ form.subnet_mask.errors[0] }}</small>{% endif %}
                            </label>
                            <label class="form-field{% if form.gateway.errors %} has-error{% endif %}">
                                <span>Gateway</span>
                                {{ form.gateway(class_='input') }}
                                {% if form.gateway.errors %}<small class="input-error">{{ form.gateway.errors[0] }}</small>{% endif %}
                            </label>
                            <label class="form-field{% if form.unit_id.errors %} has-error{% endif %}">
                                <span>Unit ID</span>
                                {{ form.unit_id(class_='input') }}
                                {% if form.unit_id.errors %}<small class="input-error">{{ form.unit_id.errors[0] }}</small>{% endif %}
                            </label>
                            <label class="form-field{% if form.manufacturer.errors %} has-error{% endif %}">
                                <span>Fabricante</span>
                                {{ form.manufacturer(class_='input') }}
                                {% if form.manufacturer.errors %}<small class="input-error">{{ form.manufacturer.errors[0] }}</small>{% endif %}
                            </label>
                            <label class="form-field{% if form.model.errors %} has-error{% endif %}">
                                <span>Modelo</span>
                                {{ form.model(class_='input') }}
                                {% if form.model.errors %}<small class="input-error">{{ form.model.errors[0] }}</small>{% endif %}
                            </label>
                            <label class="form-field{% if form.firmware_version.errors %} has-error{% endif %}">
                                <span>Firmware</span>
                                {{ form.firmware_version(class_='input') }}
                                {% if form.firmware_version.errors %}<small class="input-error">{{ form.firmware_version.errors[0] }}</small>{% endif %}
                            </label>
                            <label class="form-field{% if form.tags.errors %} has-error{% endif %}">
                                <span>Tags</span>
                                {{ form.tags(class_='input', placeholder='crítico, linha-1, modbus') }}
                                {% if form.tags.errors %}<small class="input-error">{{ form.tags.errors[0] }}</small>{% endif %}
                            </label>
                            <label class="checkbox">{{ form.is_active() }} Activo</label>
                        </div>
                        <label class="form-field{% if form.description.errors %} has-error{% endif %}">
                            <span>Descrição</span>
                            {{ form.description(class_='input', rows=3) }}
                            {% if form.description.errors %}<small class="input-error">{{ form.description.errors[0] }}</small>{% endif %}
                        </label>
                        <div class="actions">
                            {{ form.submit(class_='btn primary') }}
                        </div>
                    </form>
                </div>
            </section>

            <section class="management-tab-panel" data-view="inventory" role="tabpanel" hidden>
                <div class="card">
                    <div class="inventory-toolbar">
                        <div class="inventory-header">
                            <h2>Inventário de CLPs</h2>
                            <span class="inventory-caption">{{ total_plcs }} registos listados</span>
                        </div>
                        <div class="inventory-actions">
                            <label class="inventory-search">
                                <span class="sr-only">Pesquisar</span>
                                <input type="search" class="input" placeholder="Pesquisar por nome, IP ou tag" data-table-filter="#clp-table">
                            </label>
                        </div>
                    </div>

                    {% if plcs %}
                    <div class="table-responsive">
                        <table class="table table--interactive" id="clp-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Endereço IP</th>
                                    <th>Protocolo</th>
                                    <th>Rede</th>
                                    <th>Estado</th>
                                    <th>Tags</th>
                                    <th class="table-actions">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for plc in plcs %}
                                <tr data-state="{{ 'active' if plc.is_active else 'inactive' }}">
                                    <td>
                                        <strong>{{ plc.name }}</strong>
                                        <small class="table-subtitle">Criado em {{ plc.created_at.strftime('%d/%m/%Y') if plc.created_at else '-' }}</small>
                                    </td>
                                    <td>{{ plc.ip_address }}</td>
                                    <td>{{ plc.protocol|upper }}</td>
                                    <td>
                                        <div class="table-meta">Porta {{ plc.port }}</div>
                                        <div class="table-meta">VLAN {{ plc.vlan_id or '—' }}</div>
                                    </td>
                                    <td>
                                        {% if plc.is_active %}
                                            <span class="status-indicator status-indicator--online">Activo</span>
                                        {% else %}
                                            <span class="status-indicator status-indicator--offline">Inactivo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set tags = plc.tags_as_list() %}
                                        {% if tags %}
                                            <ul class="tag-list-inline">
                                                {% for tag in tags %}
                                                <li>{{ tag }}</li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <span class="text-muted">Sem tags</span>
                                        {% endif %}
                                    </td>
                                    <td class="actions">
                                        <a class="btn secondary" href="{{ url_for('clp_bp.clp', ip=plc.ip_address, vlan=plc.vlan_id) }}">Detalhes</a>
                                        <a class="btn" href="{{ url_for('admin.edit_clp', plc_id=plc.id, next=url_for('clp_bp.clp', ip=plc.ip_address, vlan=plc.vlan_id)) }}">Editar</a>
                                        <form class="inline-form" method="POST" action="{{ url_for('admin.delete_clp', plc_id=plc.id) }}" onsubmit="return confirm('Tem certeza que deseja remover este CLP? Esta acção é irreversível.');">
                                            {{ csrf_token() }}
                                            <button type="submit" class="btn danger">Eliminar</button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                        <p class="text-muted">Nenhum CLP registado até o momento.</p>
                    {% endif %}
                </div>
            </section>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='scripts/management.js') }}"></script>
{% endblock %}
