{% extends 'layouts/base.html' %}
{% block title %}Dashboard Industrial{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/dashboard/dashboard.css') }}">
{% endblock %}

{% block content %}
<section class="dashboard-header">
  <div>
    <h1>Visão Geral da Fábrica</h1>
    <p>Acompanhe a saúde dos CLPs, registradores e VLANs em tempo real.</p>
  </div>
  <div class="header-actions">
    {% if is_admin %}
    <button id="toggle-edit" class="btn btn-secondary" type="button">Alternar modo de edição</button>
    <button id="save-layout" class="btn btn-primary" type="button">Salvar layout</button>
    {% endif %}
    <div class="export-all-controls">
      <label for="dashboard-export-format">Exportar registradores</label>
      <div class="export-all-controls__row">
        <select id="dashboard-export-format" class="input-form">
          <option value="xlsx">XLSX</option>
          <option value="csv">CSV</option>
        </select>
        <button id="dashboard-export-all" class="btn btn-secondary" type="button">Exportar todos os CLPs</button>
      </div>
    </div>
  </div>
</section>

<div id="dashboard-export-feedback" class="export-feedback" role="status" aria-live="polite"></div>

<section class="summary-cards" aria-label="Indicadores principais">
  <article class="summary-card" data-summary="total-clps">
    <h2>Total de CLPs</h2>
    <p class="metric">--</p>
  </article>
  <article class="summary-card" data-summary="online-clps">
    <h2>CLPs Online</h2>
    <p class="metric">--</p>
  </article>
  <article class="summary-card" data-summary="offline-clps">
    <h2>CLPs Offline</h2>
    <p class="metric">--</p>
  </article>
  <article class="summary-card" data-summary="inactive-clps">
    <h2>CLPs Inativos</h2>
    <p class="metric">--</p>
  </article>
  <article class="summary-card" data-summary="active-alarms">
    <h2>Alarmes ativos</h2>
    <p class="metric">--</p>
  </article>
  <article class="summary-card" data-summary="total-registers">
    <h2>Registradores monitorados</h2>
    <p class="metric">--</p>
  </article>
  <article class="summary-card" data-summary="active-vlans">
    <h2>Redes monitoradas</h2>
    <p class="metric">--</p>
  </article>
  <article class="summary-card" data-summary="logs-last-24h">
    <h2>Leituras (24h)</h2>
    <p class="metric">--</p>
  </article>
</section>

<section id="plc-card-section" class="plc-card-section" aria-label="CLPs monitorados">
  <header class="plc-card-header">
    <h2>CLPs monitorados</h2>
    <p>Acompanhe status, alarmes e métricas sem sair do painel principal.</p>
  </header>
  <div id="plc-card-list" class="plc-card-list" data-empty-text="Nenhum CLP cadastrado"></div>
</section>

<section class="charts-grid">
  <div class="chart-card">
    <header>
      <h2>Tendência de leituras</h2>
    </header>
    <div class="chart-container">
      <canvas id="logVolumeChart" aria-label="Volume de leituras por dia" role="img"></canvas>
    </div>
  </div>
  <div class="chart-card">
    <header>
      <h2>Distribuição de alarmes</h2>
    </header>
    <div class="chart-container">
      <canvas id="alarmDistributionChart" aria-label="Alarmes por prioridade" role="img"></canvas>
    </div>
  </div>
  <div class="chart-card">
    <header>
      <h2>CLPs com incidentes</h2>
    </header>
    <ul id="incident-list" class="incident-list" aria-live="polite"></ul>
  </div>
</section>

<section id="factory-layout-section" class="layout-section">
  <header class="layout-header">
    <div>
      <h2>Mapa da Fábrica</h2>
      <p>Visualize a topologia por VLAN, CLP e registradores.</p>
    </div>
    <div class="layout-controls">
      <div id="layout-status" role="status" aria-live="polite"></div>
      <div class="layout-buttons">
        <button id="fullscreen-toggle" class="btn btn-secondary" type="button">Tela cheia</button>
        <button id="reset-layout-view" class="btn btn-link" type="button">Centralizar</button>
      </div>
    </div>
  </header>
  <div class="layout-container">
    <div id="layout-viewport" class="layout-viewport">
      <div
        id="factory-layout"
        class="layout-canvas"
        data-editable="{{ 'true' if is_admin else 'false' }}"
        tabindex="0"
      ></div>
    </div>
    <aside id="plc-inspector" class="inspector hidden" aria-live="polite" tabindex="-1">
      <button id="close-inspector" class="btn btn-link" type="button">Fechar</button>
      <div class="inspector-content">
        <h3 id="inspector-title">Detalhes do CLP</h3>
        <dl id="inspector-details" class="inspector-details"></dl>
        <section>
          <h4>Registradores monitorados</h4>
          <ul id="inspector-registers" class="inspector-registers"></ul>
        </section>
      </div>
    </aside>
  </div>
</section>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js" defer></script>
<script>
  window.DASHBOARD_CONTEXT = {
    isAdmin: {{ 'true' if is_admin else 'false' }},
    csrfToken: document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
  };
</script>
<script src="{{ url_for('static', filename='scripts/dashboard.js') }}" defer></script>
{% endblock %}
